{% extends "base.html" %}

{% block title %}Attendance Graph{% endblock %}

{% block content %}
<h2>Attendance for {{ subject }}</h2>

<div class="card">
    <canvas id="attendanceChart"></canvas>
</div>

<div class="card mt-4">
    <h3>Detailed Records</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Hour</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>{{ record[0] }}</td>
                <td>{{ record[2] }}</td>
                <td>
                    <span class="{% if record[1] == 'Present' %}text-success{% else %}text-danger{% endif %}"
                        style="font-weight: bold;">
                        {{ record[1] }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3 text-center">
    <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('attendanceChart').getContext('2d');

    // Parse the Jinja variables safely into JavaScript Arrays
    const dates = JSON.parse('{{ dates | tojson | safe }}');
    const statuses = JSON.parse('{{ statuses | tojson | safe }}'); // 1 for Present, 0 for Absent

    // Define Theme Colors
    const greenColor = '#00b894';
    const redColor = '#d63031';
    const greenBg = 'rgba(0, 184, 148, 0.2)';
    const redBg = 'rgba(214, 48, 49, 0.2)';

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Attendance',
                data: statuses,
                borderWidth: 2,
                fill: true,
                tension: 0.1,
                stepped: true,

                // Color the points based on value (1=Green, 0=Red)
                pointBackgroundColor: statuses.map(s => s === 1 ? greenColor : redColor),
                pointBorderColor: statuses.map(s => s === 1 ? greenColor : redColor),
                pointRadius: 5,
                pointHoverRadius: 7,

                // Color the line segments and fill area based on value
                segment: {
                    borderColor: ctx => ctx.p0.parsed.y === 1 ? greenColor : redColor,
                    backgroundColor: ctx => ctx.p0.parsed.y === 1 ? greenBg : redBg,
                }
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.2, // Adds a little space at top
                    ticks: {
                        stepSize: 1,
                        font: { weight: 'bold' },
                        // Custom labels for Y-axis
                        callback: function (value) {
                            if (value === 0) return 'Absent';
                            if (value === 1) return 'Present';
                            return '';
                        },
                        // Color the Y-axis text
                        color: (context) => {
                            if (context.tick.value === 1) return greenColor;
                            if (context.tick.value === 0) return redColor;
                            return '#666';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false // Hide legend since colors explain the status
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.raw === 1 ? 'Present' : 'Absent';
                        }
                    }
                }
            }
        }
    });
</script>

<!-- CSS to ensure the text colors apply correctly -->
<style>
    .text-success {
        color: #00b894 !important;
    }

    .text-danger {
        color: #d63031 !important;
    }
</style>
{% endblock %}