{% extends "base.html" %}

{% block title %}Attendance Graph{% endblock %}

{% block content %}
<h2>Attendance for {{ subject }}</h2>

<div class="card">
    <canvas id="attendanceChart"></canvas>
</div>

<div class="card mt-4">
    <h3>Detailed Records</h3>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Hour</th>
                <th>Status</th>
                <th>Review</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr>
                <td>{{ record[1] }}</td>
                <td>{{ record[3] }}</td>
                <td>
                    <span class="{% if record[2] == 'Present' %}text-success{% else %}text-danger{% endif %}"
                        style="font-weight: bold;">
                        {{ record[2] }}
                    </span>
                </td>
                <td>
                    {% if record[2] == 'Absent' %}
                    <button class="btn btn-sm btn-primary"
                        onclick="openRequestModal('{{ record[0] }}', '{{ record[1] }}')">
                        Request Change
                    </button>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3 text-center">
    <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
</div>

<!-- Request Change Modal -->
<div id="requestModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content"
        style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;">
        <span class="close" onclick="closeRequestModal()"
            style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3>Request Attendance Change</h3>
        <p>Date: <span id="modalDate"></span></p>

        <form action="/student/request_change" method="POST" enctype="multipart/form-data">
            <input type="hidden" id="modalAttendanceId" name="attendance_id">

            <div class="form-group">
                <label for="reason">Reason for Absence:</label>
                <textarea id="reason" name="reason" rows="3" required
                    style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;"></textarea>
            </div>

            <div class="form-group">
                <label for="document">Upload Document (Optional):</label>
                <input type="file" id="document" name="document" accept=".pdf,.jpg,.jpeg,.png">
                <small class="text-muted">Medical certificate, volunteering proof, etc.</small>
            </div>

            <div class="text-center mt-3">
                <button type="submit" class="btn btn-success">Submit Request</button>
                <button type="button" class="btn btn-secondary" onclick="closeRequestModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('attendanceChart').getContext('2d');

    // Parse the Jinja variables safely into JavaScript Arrays
    const dates = JSON.parse('{{ dates | tojson | safe }}');
    const statuses = JSON.parse('{{ statuses | tojson | safe }}'); // 1 for Present, 0 for Absent

    // Define Theme Colors
    const greenColor = '#00b894';
    const redColor = '#d63031';

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Attendance',
                data: statuses,
                borderColor: '#6c5ce7',
                borderWidth: 2,
                fill: true,
                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                tension: 0.1,
                stepped: true,
                pointBackgroundColor: statuses.map(s => s === 1 ? greenColor : redColor),
                pointBorderColor: statuses.map(s => s === 1 ? greenColor : redColor),
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.2,
                    ticks: {
                        stepSize: 1,
                        font: { weight: 'bold' },
                        callback: function (value) {
                            if (value === 0) return 'Absent';
                            if (value === 1) return 'Present';
                            return '';
                        },
                        color: (context) => {
                            if (context.tick.value === 1) return greenColor;
                            if (context.tick.value === 0) return redColor;
                            return '#666';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.raw === 1 ? 'Present' : 'Absent';
                        }
                    }
                }
            }
        }
    });

    // Modal Logic
    function openRequestModal(id, date) {
        document.getElementById('modalAttendanceId').value = id;
        document.getElementById('modalDate').textContent = date;
        document.getElementById('requestModal').style.display = "block";
    }

    function closeRequestModal() {
        document.getElementById('requestModal').style.display = "none";
    }

    // Close modal if clicked outside
    window.onclick = function (event) {
        if (event.target == document.getElementById('requestModal')) {
            closeRequestModal();
        }
    }
</script>

<!-- CSS to ensure the text colors apply correctly -->
<style>
    .text-success {
        color: #00b894 !important;
    }

    .text-danger {
        color: #d63031 !important;
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.8rem;
    }
</style>
{% endblock %}