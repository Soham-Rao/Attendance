{% extends "base.html" %}

{% block title %}Manage Teachers{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>Manage Teachers</h2>
    <p class="text-muted">Add teachers and assign them to classes/subjects</p>
</div>

<div class="grid" style="grid-template-columns: 1fr 1fr; gap: 40px;">
    <!-- Add Teacher Form -->
    <div class="card">
        <h3><i class="fas fa-user-plus"></i> Add New Teacher</h3>
        <form action="/add_teacher" method="POST" class="mt-4">
            <div class="form-group">
                <label>Teacher ID (Unique)</label>
                <input type="text" name="teacher_id" required placeholder="e.g. T001">
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="name" required placeholder="e.g. John Doe">
            </div>
            <div class="form-group">
                <label>Date of Birth (Password)</label>
                <input type="date" name="dob" required>
                <small class="text-muted">Format: dd/mm/yyyy (will be stored as ddmmyyyy)</small>
            </div>
            <button type="submit" class="btn btn-primary">Add Teacher</button>
        </form>
    </div>

    <!-- Assign Teacher Form -->
    <div class="card">
        <h3><i class="fas fa-link"></i> Assign Class & Subject</h3>
        <form action="/assign_teacher" method="POST" class="mt-4">
            <div class="form-group">
                <label>Select Teacher</label>
                <select name="teacher_id" required>
                    <option value="">-- Select Teacher --</option>
                    {% for teacher in teachers %}
                    <option value="{{ teacher[1] }}">{{ teacher[2] }} ({{ teacher[1] }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Select Class</label>
                <select name="class_id" id="classSelect" required onchange="loadSubjects()">
                    <option value="">-- Select Class --</option>
                    {% for cls in classes %}
                    <option value="{{ cls[0] }}">{{ cls[1] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Select Subject</label>
                <select name="subject" id="subjectSelect" required disabled>
                    <option value="">-- Select Class First --</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Assign Teacher</button>
        </form>
    </div>
</div>

<!-- List of Assignments -->
<div class="card mt-4">
    <h3>Current Assignments</h3>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Class</th>
                    <th>Subject</th>
                </tr>
            </thead>
            <tbody>
                {% for assignment in assignments %}
                <tr>
                    <td>{{ assignment[1] }}</td>
                    <td>{{ assignment[2] }}</td>
                    <td>{{ assignment[3] }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="text-center text-muted">No assignments found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="text-center mt-4">
    <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
</div>

<script>
    function loadSubjects() {
        const classId = document.getElementById('classSelect').value;
        const subjectSelect = document.getElementById('subjectSelect');

        // Reset dropdown
        subjectSelect.innerHTML = '<option value="">Loading...</option>';
        subjectSelect.disabled = true;

        if (!classId) {
            subjectSelect.innerHTML = '<option value="">-- Select Class First --</option>';
            return;
        }

        fetch(`/api/get_subjects/${classId}`)
            .then(response => response.json())
            .then(data => {
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
                if (data.length === 0) {
                    subjectSelect.innerHTML += '<option value="" disabled>No subjects found</option>';
                } else {
                    data.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        subjectSelect.appendChild(option);
                    });
                    subjectSelect.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error fetching subjects:', error);
                subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
            });
    }
</script>
{% endblock %}