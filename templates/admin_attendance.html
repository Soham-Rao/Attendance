{% extends "base.html" %}

{% block title %}Manage Attendance{% endblock %}

{% block content %}
<h2>Manage Attendance Records</h2>

<div class="card">
    <form method="GET" action="/admin/attendance" class="dashboard-grid"
        style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 0;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>Class:</label>
            <select name="class_id" onchange="this.form.submit()">
                <option value="">-- All Classes --</option>
                {% for cls in classes %}
                <option value="{{ cls[0] }}" {% if selected_class==cls[0] %}selected{% endif %}>{{ cls[1] }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Subject:</label>
            <select name="subject" onchange="this.form.submit()">
                <option value="">-- All Subjects --</option>
                {% for sub in subjects %}
                <option value="{{ sub }}" {% if selected_subject==sub %}selected{% endif %}>{{ sub }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Hour:</label>
            <select name="hour" onchange="this.form.submit()">
                <option value="">-- All Hours --</option>
                {% for i in range(1, 8) %}
                <option value="{{ i }}" {% if selected_hour==i|string %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Date:</label>
            <input type="date" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Student:</label>
            <select name="student_id" onchange="this.form.submit()">
                <option value="">-- All Students --</option>
                {% for stu in students_list %}
                <option value="{{ stu[0] }}" {% if selected_student==stu[0] %}selected{% endif %}>{{ stu[1] }} ({{
                    stu[2] }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
            <a href="/admin/attendance" class="btn btn-secondary" style="width: 100%;">Reset Filters</a>
        </div>
    </form>
</div>

{% if attendance_records %}
<div class="card">
    <form method="POST"
        action="/admin/attendance?class_id={{ selected_class or '' }}&subject={{ selected_subject or '' }}&hour={{ selected_hour or '' }}&date={{ selected_date or '' }}&student_id={{ selected_student or '' }}">

        <input type="hidden" name="class_id" value="{{ selected_class or '' }}">
        <input type="hidden" name="subject" value="{{ selected_subject or '' }}">
        <input type="hidden" name="hour" value="{{ selected_hour or '' }}">
        <input type="hidden" name="date" value="{{ selected_date or '' }}">
        <input type="hidden" name="student_id" value="{{ selected_student or '' }}">

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>USN</th>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Hour</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Comments</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance_records %}
                <tr {% if record[0] in pending_ids %}class="pending-change" {% endif %}>
                    <td>{{ record[0] }}</td>
                    <td>{{ record[1] }}</td>
                    <td>{{ record[2] }}</td>
                    <td>{{ record[3] }}</td>
                    <td>{{ record[4] }}</td>
                    <td>{{ record[5] }}</td>
                    <td>
                        <select name="status_{{ record[0] }}" class="status-select"
                            data-original-status="{{ record[6] }}" data-row-id="{{ record[0] }}"
                            onchange="highlightChangedRow(this)" style="padding: 5px; width: auto;">
                            <option value="Present" {% if record[6]=='Present' %}selected{% endif %}>Present</option>
                            <option value="Absent" {% if record[6]=='Absent' %}selected{% endif %}>Absent</option>
                        </select>
                    </td>
                    <td>
                        {% if session['role'] == 'teacher' %}
                        <textarea name="individual_{{ record[0] }}" class="individual-comment-input"
                            placeholder="Individual comment (optional)" rows="2" disabled
                            style="width: 100%; padding: 5px; font-size: 0.9rem; resize: vertical;"></textarea>
                        {% elif session['role'] == 'admin' %}
                        <button type="submit" formaction="/delete_attendance/{{ record[0] }}" class="btn btn-danger"
                            onclick="return confirm('⚠️ Are you sure you want to delete this attendance record?\n\nStudent: {{ record[2] }}\nSubject: {{ record[3] }}\nDate: {{ record[5] }}\n\nThis action cannot be undone!');"
                            style="padding: 5px 10px; font-size: 14px;">Delete</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if session['role'] == 'teacher' %}
        <div style="margin-top: 20px;">
            <div style="margin-bottom: 15px;">
                <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="use_same_comment" name="use_same_comment" checked
                        onchange="toggleIndividualComments()" style="margin: 0;">
                    <span>Use same comment for all changes</span>
                </label>
            </div>

            <label>Group Comment (Required):</label>
            <textarea name="reason" id="group_comment" required class="form-control"
                placeholder="Explain why you are changing the attendance status..." rows="3"
                style="width: 100%; margin-top: 5px;"></textarea>

            <div
                style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-left: 3px solid #007bff; border-radius: 3px;">
                <small style="color: #6c757d;"><i class="fas fa-info-circle"></i> <strong>Tip:</strong> Uncheck the box
                    above to add individual comments per record in the Comments column.</small>
            </div>
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button type="submit" class="btn btn-warning">Request Changes</button>
        </div>

        <script>
            function toggleIndividualComments() {
                const checkbox = document.getElementById('use_same_comment');
                const textareas = document.querySelectorAll('.individual-comment-input');
                textareas.forEach(textarea => {
                    textarea.disabled = checkbox.checked;
                    textarea.style.backgroundColor = checkbox.checked ? '#e9ecef' : '#ffffff';
                });
            }

            function highlightChangedRow(selectElement) {
                const row = selectElement.closest('tr');
                const originalStatus = selectElement.dataset.originalStatus;
                const currentStatus = selectElement.value;

                if (originalStatus !== currentStatus) {
                    row.classList.add('pending-change');
                } else {
                    row.classList.remove('pending-change');
                }
            }
        </script>
        {% else %}
        <div style="margin-top: 20px; text-align: right;">
            <button type="submit" class="btn btn-success">Update Changes</button>
        </div>
        {% endif %}
    </form>
</div>
{% else %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> No attendance records found for the selected filters.
</div>
{% endif %}

<style>
    .pending-change {
        background-color: #fff3cd !important;
        border-left: 4px solid #ff9800;
        transition: all 0.3s ease;
    }

    .pending-change td {
        font-weight: 500;
    }
</style>
{% endblock %}