{% extends "base.html" %}

{% block title %}Manage Attendance{% endblock %}

{% block content %}
<h2>Manage Attendance Records</h2>

<div class="card">
    <form method="GET" action="/admin/attendance" class="dashboard-grid"
        style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 0;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>Class:</label>
            <select name="class_id" onchange="this.form.submit()">
                <option value="">-- All Classes --</option>
                {% for cls in classes %}
                <option value="{{ cls[0] }}" {% if selected_class==cls[0] %}selected{% endif %}>{{ cls[1] }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Subject:</label>
            <select name="subject" onchange="this.form.submit()">
                <option value="">-- All Subjects --</option>
                {% for sub in subjects %}
                <option value="{{ sub }}" {% if selected_subject==sub %}selected{% endif %}>{{ sub }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Hour:</label>
            <select name="hour" onchange="this.form.submit()">
                <option value="">-- All Hours --</option>
                {% for i in range(1, 8) %}
                <option value="{{ i }}" {% if selected_hour==i|string %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Date:</label>
            <input type="date" name="date" value="{{ selected_date }}" onchange="this.form.submit()">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label>Student:</label>
            <select name="student_id" onchange="this.form.submit()">
                <option value="">-- All Students --</option>
                {% for stu in students_list %}
                <option value="{{ stu[0] }}" {% if selected_student==stu[0] %}selected{% endif %}>{{ stu[1] }} ({{
                    stu[2] }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
            <a href="/admin/attendance" class="btn btn-secondary" style="width: 100%;">Reset Filters</a>
        </div>
    </form>
</div>

{% if attendance_records %}
<div class="card">
    <form method="POST" action="/admin/attendance">
        <!-- Hidden fields to preserve filters -->
        {% if selected_class %}<input type="hidden" name="class_id" value="{{ selected_class }}">{% endif %}
        {% if selected_subject %}<input type="hidden" name="subject" value="{{ selected_subject }}">{% endif %}
        {% if selected_hour %}<input type="hidden" name="hour" value="{{ selected_hour }}">{% endif %}
        {% if selected_date %}<input type="hidden" name="date" value="{{ selected_date }}">{% endif %}
        {% if selected_student %}<input type="hidden" name="student_id" value="{{ selected_student }}">{% endif %}

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>USN</th>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Hour</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in attendance_records %}
                <tr>
                    <td>{{ record[0] }}</td>
                    <td>{{ record[1] }}</td>
                    <td>{{ record[2] }}</td>
                    <td>{{ record[3] }}</td>
                    <td>{{ record[4] }}</td> <!-- Hour -->
                    <td>{{ record[5] }}</td> <!-- Date -->
                    <td>
                        <select name="status_{{ record[0] }}" style="padding: 5px; width: auto;">
                            <option value="Present" {% if record[6]=='Present' %}selected{% endif %}>Present</option>
                            <option value="Absent" {% if record[6]=='Absent' %}selected{% endif %}>Absent</option>
                        </select>
                    </td>
                    <td>
                        <button type="submit" formaction="/delete_attendance/{{ record[0] }}" class="btn btn-danger"
                            style="padding: 5px 10px; font-size: 14px;">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 20px; text-align: right;">
            <button type="submit" class="btn btn-success">Update Changes</button>
            <a href="{{ url_for('download_attendance', class_id=selected_class, subject=selected_subject, date=selected_date, student_id=selected_student) }}"
                class="btn btn-primary">Download CSV</a>
        </div>
    </form>
</div>
{% else %}
<div class="alert alert-info">No attendance records found for the selected filters.</div>
{% endif %}
{% endblock %}