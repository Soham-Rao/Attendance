{% extends "base.html" %}

{% block title %}Student Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <h2>Welcome, {{ usn }}</h2>
    <p class="text-muted">Here's your attendance overview</p>
</div>

<div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 2rem;">
    <!-- Current Status Card -->
    <div class="card">
        <h3><i class="fas fa-clock" style="color: var(--primary); margin-right: 10px;"></i> Current Status</h3>
        <div style="margin-top: 1.5rem;">
            {% if current_subject %}
            <div style="margin-bottom: 1rem;">
                <span class="text-muted">Subject</span>
                <div style="font-size: 1.2rem; font-weight: 600;">{{ current_subject }}</div>
            </div>
            <div>
                <span class="text-muted">Status</span>
                <div class="{% if current_status == 'Present' %}text-success{% else %}text-danger{% endif %}"
                    style="font-size: 1.2rem; font-weight: 600;">
                    {{ current_status }}
                </div>
            </div>
            {% else %}
            <div class="text-muted" style="font-style: italic;">No class ongoing right now.</div>
            {% endif %}
        </div>
    </div>

    <!-- Overall Attendance Card -->
    <div class="card"
        style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%); color: white;">
        <h3
            style="color: white; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; margin-bottom: 20px;">
            Overall Attendance
        </h3>
        <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div class="text-center">
                <div style="font-size: 3.5rem; font-weight: 700; line-height: 1;">{{ overall_percentage }}%</div>
                <div style="font-size: 1rem; opacity: 0.9; margin-top: 5px;">{{ total_present }}/{{ total_classes }}
                    Classes</div>
            </div>
            <div style="position: relative; width: 140px; height: 140px;">
                <canvas id="overallChart"></canvas>
            </div>
        </div>
    </div>
</div>

<h3 class="mb-3">Subject-wise Attendance</h3>
<div class="dashboard-grid">
    {% for subject in subject_stats %}
    <a href="/attendance_graph/{{ subject.name }}" class="card dashboard-card"
        style="border-top: 4px solid {% if subject.status_color == 'success' %}var(--success){% elif subject.status_color == 'warning' %}var(--warning){% else %}var(--error){% endif %};">

        <div
            style="width: 60px; height: 60px; border-radius: 50%; background: {% if subject.status_color == 'success' %}rgba(0, 184, 148, 0.1){% elif subject.status_color == 'warning' %}rgba(253, 203, 110, 0.1){% else %}rgba(214, 48, 49, 0.1){% endif %}; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
            <i class="fas fa-book"
                style="font-size: 1.5rem; color: {% if subject.status_color == 'success' %}var(--success){% elif subject.status_color == 'warning' %}var(--warning){% else %}var(--error){% endif %};"></i>
        </div>

        <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">{{ subject.name }}</h3>

        <div
            style="font-size: 2.5rem; font-weight: 700; color: {% if subject.status_color == 'success' %}var(--success){% elif subject.status_color == 'warning' %}var(--warning){% else %}var(--error){% endif %};">
            {{ subject.percentage }}%
        </div>

        <div
            style="width: 100%; background: #f1f2f6; height: 8px; border-radius: 4px; margin: 1rem 0; overflow: hidden;">
            <div
                style="height: 100%; width: {{ subject.percentage }}%; background: {% if subject.status_color == 'success' %}var(--success){% elif subject.status_color == 'warning' %}var(--warning){% else %}var(--error){% endif %}; border-radius: 4px;">
            </div>
        </div>

        <p class="text-muted" style="font-size: 0.9rem;">{{ subject.present }}/{{ subject.total }} Classes</p>
    </a>
    {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('overallChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Present', 'Absent'],
                datasets: [{
                    data: [{{ overall_percentage }}, 100 - {{ overall_percentage }}],
            backgroundColor: ['#ffffff', 'rgba(255, 255, 255, 0.2)'],
            borderWidth: 0
        }]
            },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
        },
        cutout: '75%'
    }
        });
    });
</script>
{% endblock %}