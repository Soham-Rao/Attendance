{% extends "base.html" %}

{% block title %}Live Attendance{% endblock %}

{% block content %}
<div class="container live-container">
    <!-- Video Section -->
    <div class="live-video-section">
        <div class="card"
            style="flex: 1; padding: 0; overflow: hidden; background: #000; position: relative; display: flex; justify-content: center; align-items: center; border-radius: var(--radius-md);">
            <video id="video" autoplay playsinline style="display: none;"></video>
            <canvas id="canvas" style="max-width: 100%; max-height: 100%; object-fit: contain;"></canvas>
            <div id="status-overlay"
                style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 500; backdrop-filter: blur(4px);">
                Initializing...
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="live-sidebar-section">
        <div class="card" style="height: 100%; display: flex; flex-direction: column; padding: 1.5rem;">
            <h3 class="mb-3" style="border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;">{{ subject }}</h3>

            <div id="counter-box" class="mb-3"
                style="background: rgba(0, 184, 148, 0.1); color: var(--success); border: 2px solid var(--success); border-radius: var(--radius-sm); padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <strong>Present</strong>
                <span style="font-size: 1.2em; font-weight: bold;"><span id="present-count">0</span> / {{ total_students
                    }}</span>
            </div>

            <div id="last-detected-box" class="mb-3"
                style="background: rgba(108, 92, 231, 0.1); color: var(--primary); border: 2px solid var(--primary); border-radius: var(--radius-sm); padding: 1rem; display: flex; align-items: center;">
                <strong style="margin-right: 10px;">Last:</strong> <span id="last-detected-name">None</span>
            </div>

            <h4 class="mb-2"
                style="font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);">
                Detected Students</h4>

            <div id="detected-list-container"
                style="flex-grow: 1; overflow-y: auto; margin-bottom: 1rem; padding-right: 5px;">
                <ul id="student-list" style="list-style: none; padding: 0; margin: 0;">
                    <!-- List items will go here -->
                </ul>
            </div>

            <div class="mt-3">
                <button id="stop-btn" onclick="stopAttendance()" class="btn btn-danger"
                    style="width: 100%; justify-content: center;">
                    <i class="fas fa-stop-circle"></i> Stop & Submit
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusOverlay = document.getElementById('status-overlay');
    const studentList = document.getElementById('student-list');
    const presentCountSpan = document.getElementById('present-count');
    const lastDetectedName = document.getElementById('last-detected-name');

    const CLASS_ID = "{{ class_id }}";
    const SUBJECT = "{{ subject }}";
    const HOUR = "{{ hour }}";
    const EXISTING_PRESENT_DATA = {{ existing_present_data | tojson }};

    let isRunning = true;
    let detectedStudents = new Set(); // Store IDs of detected students
    let lastDetectedId = null;
    let lastTikTime = {}; // Map student_id -> timestamp

    // Initialize with existing data
    if (EXISTING_PRESENT_DATA && EXISTING_PRESENT_DATA.length > 0) {
        EXISTING_PRESENT_DATA.forEach(student => {
            detectedStudents.add(student.id);
            const li = document.createElement('li');
            li.innerHTML = `<span style="color: #2ecc71; margin-right: 10px;">✔</span> ${student.name}`;
            li.style.padding = "8px 10px";
            li.style.borderBottom = "1px solid #eee";
            studentList.prepend(li);
        });
        presentCountSpan.innerText = detectedStudents.size;
    }

    // --- Audio ---
    const dingAudio = new Audio('/static/sounds/ding.wav');
    const tikAudio = new Audio('/static/sounds/tik.wav');

    function playDing() {
        dingAudio.currentTime = 0;
        dingAudio.play().catch(e => console.log("Audio play failed:", e));
    }

    function playTik() {
        tikAudio.currentTime = 0;
        tikAudio.play().catch(e => console.log("Audio play failed:", e));
    }

    // --- Camera & Logic ---

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                statusOverlay.innerText = "Camera Active";
                processFrame();
                animationLoop();
            };
        } catch (err) {
            statusOverlay.innerText = "Error: " + err.message;
            console.error(err);
        }
    }

    async function processFrame() {
        if (!isRunning) return;

        const imageData = canvas.toDataURL('image/jpeg', 0.9);

        try {
            const response = await fetch('/api/recognize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    image: imageData,
                    class_id: CLASS_ID
                })
            });

            const data = await response.json();

            if (data.results) {
                lastResults = data.results;
                lastResultTime = Date.now();
                handleDetections(data.results);
            }

        } catch (err) {
            console.error("API Error:", err);
        }

        if (isRunning) setTimeout(processFrame, 400);
    }

    function handleDetections(results) {
        results.forEach(res => {
            if (!res.student_id) return; // Ignore unknown

            const now = Date.now();

            if (!detectedStudents.has(res.student_id)) {
                // NEW STUDENT
                detectedStudents.add(res.student_id);

                // Update UI
                presentCountSpan.innerText = detectedStudents.size;
                lastDetectedName.innerText = res.name + " ✔";

                const li = document.createElement('li');
                li.innerHTML = `<span style="color: #2ecc71; margin-right: 10px;">✔</span> ${res.name}`;
                li.style.padding = "8px 10px";
                li.style.borderBottom = "1px solid #eee";
                studentList.prepend(li); // Add to top

                // Play Ding
                playDing();
            } else {
                // ALREADY DETECTED
                // Play Tik if cooldown passed (e.g., 3 seconds)
                if (!lastTikTime[res.student_id] || (now - lastTikTime[res.student_id] > 3000)) {
                    playTik();
                    lastTikTime[res.student_id] = now;
                    // Optional: Update last detected name even if already in list, to show they are being seen *now*
                    lastDetectedName.innerText = res.name + " ✔";
                }
            }
        });
    }

    let lastResults = [];
    let lastResultTime = 0;
    const RESULT_TIMEOUT = 2000;

    function animationLoop() {
        if (!isRunning) return;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        if (Date.now() - lastResultTime > RESULT_TIMEOUT) {
            lastResults = [];
        }

        lastResults.forEach(res => {
            const [top, right, bottom, left] = res.box;
            const name = res.name;
            const isKnown = !!res.student_id;
            const color = isKnown ? "#00FF00" : "#FF0000";

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.strokeRect(left, top, right - left, bottom - top);

            ctx.fillStyle = color;
            ctx.font = "bold 18px Arial";
            ctx.fillText(name, left, top - 10);
        });

        requestAnimationFrame(animationLoop);
    }

    async function stopAttendance() {
        isRunning = false;
        video.srcObject.getTracks().forEach(track => track.stop());
        statusOverlay.innerText = "Submitting...";

        try {
            const response = await fetch('/api/submit_attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    class_id: CLASS_ID,
                    subject: SUBJECT,
                    hour: HOUR,
                    student_ids: Array.from(detectedStudents)
                })
            });

            const res = await response.json();
            if (res.status === 'success') {
                alert("Attendance marked successfully!");
                window.location.href = "/dashboard";
            } else {
                alert("Error: " + res.message);
            }

        } catch (err) {
            alert("Error: " + err.message);
        }
    }

    startCamera();
</script>
{% endblock %}